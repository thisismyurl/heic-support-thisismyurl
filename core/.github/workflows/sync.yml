name: Push Core and Update Versions
on:
  push:
    branches: [ main ]

jobs:
  sync-and-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Core
        uses: actions/checkout@v4

      - name: Set Version Variable
        run: echo "NEW_VERSION=1.$(date +'%y%m%d')" >> $GITHUB_ENV

      - name: Run Sync and Version Script
        env:
          GH_PAT: ${{ secrets.CORE_SYNC_TOKEN }}
          VERSION: ${{ env.NEW_VERSION }}
          REPOS: "thisismyurl-svg-support,thisismyurl-webp-support,thisismyurl-heic-support,thisismyurl-external-link-control"
        run: |
          # Split the comma-separated repos into an array
          IFS=',' read -ra ADDR <<< "$REPOS"
          
          for REPO in "${ADDR[@]}"; do
            echo "Processing $REPO..."
            
            # 1. Clone the target plugin repo
            git clone https://$GH_PAT@github.com/thisismyurl/$REPO.git target-repo
            cd target-repo
            
            # 2. Sync the Core files
            mkdir -p core/assets
            cp ../class-timu-core.php core/
            cp -r ../assets/* core/assets/
            
            # 3. Update Version in the Main Plugin File (filename.php)
            # This targets the line: " * Version: 1.xxxxxx"
            sed -i "s/Version: .*/Version: $VERSION/" "$REPO.php"
            
            # 4. Update Version in readme.txt
            # This targets "Stable tag: x.x.x"
            if [ -f "readme.txt" ]; then
              sed -i "s/Stable tag: .*/Stable tag: $VERSION/" readme.txt
              
              # 5. Add Changelog entry
              # Inserts a new entry right under the == Changelog == header
              CHANGELOG_ENTRY="\n\n= $VERSION =\n* Updated core library to version $VERSION"
              sed -i "/== Changelog ==/a $CHANGELOG_ENTRY" readme.txt
            fi
            
            # 6. Commit and Push back to the plugin repo
            git config user.name "Core Sync Bot"
            git config user.email "bot@thisismyurl.com"
            git add .
            git commit -m "Automated Core Update to $VERSION" || echo "No changes to commit"
            git push origin main
            
            # 7. Cleanup for next loop
            cd ..
            rm -rf target-repo
          done